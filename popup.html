<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Image Explorer</title>
    <link rel="stylesheet" href="styles/popup.css">
  </head>
  <body>
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="collections">Collections</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="undock-btn" id="undock-btn" title="Open in separate window">
        <span class="undock-icon"></span>
        <span class="label">Undock</span>
      </button>
    </div>

    <!-- Collections Tab -->
    <div class="tab-content active" id="collections-tab">
      <div class="collections-header">
        <div class="header-left">
          <h3>Collected Images</h3>
          <span class="header-selection" id="header-selection">
            <span class="selection-count"><span id="selected-count">0</span> selected</span>
            <button class="btn btn--primary btn--sm" id="create-group-btn" title="Add selected to new group" aria-label="Add selected to new group"></button>
          </span>
        </div>
        <div class="header-actions">
          <div class="view-toggle btn-group">
            <button class="icon-btn icon-btn--default icon-btn--sm" id="list-view-btn" title="List view" aria-label="List view"></button>
            <button class="icon-btn icon-btn--default icon-btn--sm" id="grid-view-btn" title="Grid view" aria-label="Grid view"></button>
          </div>
          <div class="selection-toggle btn-group">
            <button class="icon-btn icon-btn--default icon-btn--sm" id="global-select-all" title="Select all images" aria-label="Select all images"></button>
            <button class="icon-btn icon-btn--default icon-btn--sm" id="global-deselect-all" title="Deselect all images" aria-label="Deselect all images"></button>
          </div>
          <button class="btn btn--primary btn--sm" id="add-group" title="Create new group" aria-label="Create new group"></button>
          <button class="btn btn--default btn--sm" id="download" title="Download all images" aria-label="Download all images"></button>
          <button class="btn btn--danger btn--sm" id="flush" title="Remove all images" aria-label="Remove all images"></button>
        </div>
      </div>

      <div class="main-content">
        <div class="groups-container" id="groups-container"></div>

        <div class="ungrouped-section" id="ungrouped-section">
          <div class="ungrouped-header">
            <div class="ungrouped-info">
              <div class="ungrouped-info-row">
                <span class="ungrouped-title">Ungrouped</span>
                <span class="ungrouped-count" id="ungrouped-count">(0)</span>
              </div>
              <div class="ungrouped-path" id="ungrouped-path">
                Downloads/Ungrouped
                <button class="icon-btn icon-btn--ghost icon-btn--sm" id="ungrouped-path-edit" title="Edit folder path" aria-label="Edit folder path"></button>
              </div>
            </div>
            <div class="ungrouped-actions btn-group" id="ungrouped-actions">
              <button class="icon-btn icon-btn--default icon-btn--sm" id="ungrouped-select-all" title="Select all ungrouped images" aria-label="Select all"></button>
              <button class="icon-btn icon-btn--default icon-btn--sm" id="ungrouped-deselect" title="Deselect all ungrouped images" aria-label="Deselect all"></button>
              <button class="icon-btn icon-btn--danger icon-btn--sm" id="ungrouped-remove-all" title="Remove all ungrouped images" aria-label="Remove all"></button>
            </div>
          </div>
          <ul class="image-list list-view" id="ungrouped-list"></ul>
        </div>
      </div>

      <div class="collections-footer">
        <div id="status" class="status"></div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings-tab">
      <div class="settings-content">
        <div class="settings-section">
          <h4>Download Settings</h4>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="directory-input">Root Download Folder</label>
              <span class="info-icon" data-tooltip="All downloaded images will be saved inside this folder. Group subfolders are created within it. Leave empty to use your browser's default download location.">?</span>
            </div>
            <input type="text" id="directory-input" placeholder="e.g., my-images">
          </div>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="filename-template">Filename Template</label>
              <span class="info-icon" data-tooltip="Customize filenames. Tokens: {name} = image name, {index} = number, {group} = group name. Dates: {YYYY} {YY} {MM} {DD} {hh} {mm} {ss} or {date} {time} {iso}">?</span>
            </div>
            <input type="text" id="filename-template" placeholder="{name}">
          </div>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="auto-rename">
                Auto-rename duplicates
              </label>
              <span class="info-icon" data-tooltip="When enabled, if a file with the same name already exists, a number suffix will be added automatically (e.g., image_1.jpg, image_2.jpg) instead of overwriting.">?</span>
            </div>
          </div>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="confirm-download">
                Confirm before download
              </label>
              <span class="info-icon" data-tooltip="Show a confirmation dialog before starting the download, displaying the number of images and destination folder.">?</span>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h4>Display Settings</h4>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="list-thumbnail-size">List View Thumbnail Size</label>
              <span class="info-icon" data-tooltip="Controls the size of image previews when viewing collections in list mode. Adjust to balance detail visibility with how many items fit on screen.">?</span>
            </div>
            <div class="slider-row">
              <input type="range" id="list-thumbnail-size" min="32" max="256" step="2" value="60">
              <span class="slider-value" id="list-thumbnail-value">60px</span>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="grid-thumbnail-size">Grid View Thumbnail Size</label>
              <span class="info-icon" data-tooltip="Controls the size of image previews when viewing collections in grid mode. Larger sizes show more detail but fit fewer items per row.">?</span>
            </div>
            <div class="slider-row">
              <input type="range" id="grid-thumbnail-size" min="32" max="256" step="2" value="90">
              <span class="slider-value" id="grid-thumbnail-value">90px</span>
            </div>
          </div>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="show-dimensions" checked>
                Show image dimensions
              </label>
              <span class="info-icon" data-tooltip="Display the width x height (in pixels) below each image thumbnail. Useful for identifying image resolution at a glance.">?</span>
            </div>
          </div>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="show-filetype" checked>
                Show file type
              </label>
              <span class="info-icon" data-tooltip="Display the file extension (JPG, PNG, GIF, etc.) next to each image. Helps identify the format without checking the filename.">?</span>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h4>Behavior</h4>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="clear-on-download">
                Clear list after download
              </label>
              <span class="info-icon" data-tooltip="Automatically remove all images from the collection after a successful download completes. Useful for batch workflows where you collect, download, and start fresh.">?</span>
            </div>
          </div>

          <div class="setting-item">
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="remember-groups" checked>
                Remember groups
              </label>
              <span class="info-icon" data-tooltip="Keep your group organization (names, colors, folder assignments) saved between browser sessions. When disabled, groups will be cleared when you close the browser.">?</span>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h4>Appearance</h4>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="ui-scale-select">UI Scale</label>
              <span class="info-icon" data-tooltip="Controls the size of text, icons, and buttons. Choose a larger scale if icons and text appear too small.">?</span>
            </div>
            <select id="ui-scale-select">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="density-select">Spacing Density</label>
              <span class="info-icon" data-tooltip="Controls padding and spacing between elements. Compact fits more content on screen, Spacious gives elements more breathing room.">?</span>
            </div>
            <select id="density-select">
              <option value="compact">Compact</option>
              <option value="comfortable" selected>Comfortable</option>
              <option value="spacious">Spacious</option>
            </select>
          </div>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="theme-select">Theme</label>
              <span class="info-icon" data-tooltip="Choose from popular color schemes. Themes change the overall look and feel of the extension including backgrounds, text colors, buttons, and borders.">?</span>
            </div>
            <select id="theme-select">
              <option value="default">Default Light</option>
              <option value="github-light">GitHub Light</option>
              <option value="dark">Dark</option>
              <option value="dracula">Dracula</option>
              <option value="nord">Nord</option>
              <option value="solarized-dark">Solarized Dark</option>
              <option value="monokai">Monokai</option>
            </select>
          </div>

          <div class="setting-item">
            <div class="setting-label-row">
              <label for="custom-theme-json">Custom Theme Overrides</label>
              <span class="info-icon" data-tooltip="Optionally add custom CSS variable overrides as JSON. These are applied on top of the selected theme preset, letting you fine-tune specific colors, fonts, or spacing.">?</span>
            </div>
            <textarea id="custom-theme-json" rows="4" placeholder='{"--bg-body": "#fff", "--color-primary": "#007bff"}'></textarea>
            <div class="theme-actions">
              <button type="button" id="show-theme-schema" class="btn-secondary">Show Example</button>
              <button type="button" id="apply-custom-theme" class="btn-primary">Apply Overrides</button>
            </div>
            <div id="custom-theme-error" class="theme-error"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Tooltip (shared, positioned by floating-ui) -->
    <div class="floating-tooltip" id="floating-tooltip">
      <div class="floating-tooltip-arrow" id="floating-tooltip-arrow"></div>
      <span id="floating-tooltip-text"></span>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="preview-modal">
      <button class="close-btn" id="close-preview">&times;</button>
      <img id="preview-img" src="" alt="Preview">
      <div class="preview-info">
        <div class="preview-dimensions" id="preview-dimensions"></div>
        <div class="preview-filename-edit">
          <input type="text" id="preview-filename-input" placeholder="filename">
          <span class="preview-extension" id="preview-extension"></span>
        </div>
        <div class="preview-details">
          <span id="preview-type"></span>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirm-modal">
      <div class="confirm-dialog">
        <h4 id="confirm-title">Confirm Action</h4>
        <p id="confirm-message">Are you sure?</p>
        <div class="dialog-buttons">
          <button class="cancel-btn" id="confirm-cancel">Cancel</button>
          <button class="confirm-btn" id="confirm-ok">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Drag Intent Modal -->
    <div class="drag-intent-modal" id="drag-intent-modal">
      <div class="drag-intent-dialog">
        <h4>Move Images</h4>
        <p class="drag-intent-description">You have multiple images selected. What would you like to move?</p>
        <div class="drag-intent-options">
          <button class="drag-intent-option" id="drag-intent-single">
            <div class="option-preview" id="drag-single-preview">
              <img src="" alt="">
            </div>
            <div class="option-content">
              <div class="option-header">
                <span class="option-title">Move this image only</span>
              </div>
              <div class="option-detail" id="drag-single-detail"></div>
            </div>
          </button>
          <button class="drag-intent-option" id="drag-intent-selected">
            <div class="option-content">
              <div class="option-header">
                <span class="option-title">Move all selected</span>
                <span class="option-count" id="drag-selected-count"></span>
              </div>
              <div class="option-detail" id="drag-selected-detail"></div>
            </div>
          </button>
        </div>
        <button class="drag-intent-cancel" id="drag-intent-cancel">Cancel</button>
      </div>
    </div>

    <!-- Add to Group Modal -->
    <div class="add-to-group-modal" id="add-to-group-modal">
      <div class="add-to-group-dialog">
        <h4>Add <span id="add-to-group-count">0</span> images to group</h4>
        <div class="add-to-group-options">
          <div class="add-to-group-section">
            <label class="add-to-group-label">Create new group:</label>
            <div class="new-group-input-row">
              <input type="text" id="new-group-name-input" placeholder="Enter group name...">
              <button class="btn-primary" id="create-new-group-btn">Create</button>
            </div>
          </div>
          <div class="add-to-group-divider">
            <span>or</span>
          </div>
          <div class="add-to-group-section" id="existing-groups-section">
            <label class="add-to-group-label">Add to existing group:</label>
            <div class="existing-groups-list" id="existing-groups-list">
              <!-- Populated dynamically -->
            </div>
          </div>
        </div>
        <button class="add-to-group-cancel" id="add-to-group-cancel">Cancel</button>
      </div>
    </div>

    <!-- Download Preview Modal -->
    <div class="download-preview-modal" id="download-preview-modal">
      <div class="download-preview-dialog">
        <h4>Download Preview</h4>
        <div class="download-scope-toggle">
          <button class="scope-btn active" id="scope-all">All</button>
          <button class="scope-btn" id="scope-selected">Selected</button>
        </div>
        <div class="download-options" id="download-options">
          <label class="download-option">
            <input type="checkbox" id="include-ungrouped" checked>
            <span>Include Ungrouped (<span id="ungrouped-download-count">0</span>)</span>
          </label>
        </div>
        <p class="preview-summary" id="preview-summary">0 images to download</p>
        <div class="tree-container" id="tree-container"></div>
        <div class="conflict-legend" id="conflict-legend">
          <span class="legend-item conflict">âš  Duplicate filename - resolve before downloading</span>
        </div>
        <div class="dialog-buttons">
          <button class="cancel-btn" id="download-preview-cancel">Cancel</button>
          <button class="confirm-btn download-btn" id="download-preview-confirm">Download</button>
        </div>
      </div>
    </div>

    <!-- Drop Selection Modal -->
    <div class="drop-select-modal" id="drop-select-modal">
      <div class="drop-select-dialog">
        <h4>Select Items to Add</h4>
        <p class="drop-select-summary" id="drop-select-summary">Multiple items detected</p>
        <div class="drop-select-actions">
          <button class="drop-select-action" id="drop-select-all">Select All</button>
          <button class="drop-select-action" id="drop-select-none">Select None</button>
          <button class="drop-select-action" id="drop-select-recommended">Smart Select</button>
        </div>
        <div class="drop-select-items" id="drop-select-items"></div>
        <div class="drop-select-footer">
          <span class="drop-select-count" id="drop-select-count">0 selected</span>
          <div class="dialog-buttons">
            <button class="cancel-btn" id="drop-select-cancel">Cancel</button>
            <button class="confirm-btn" id="drop-select-confirm">Add Selected</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Directory Edit Modal -->
    <div class="dir-edit-modal" id="dir-edit-modal">
      <div class="dir-edit-dialog">
        <h4>Custom Download Folder</h4>
        <p class="hint">Leave empty to use the group name as the folder name.</p>
        <input type="text" id="dir-edit-input" placeholder="e.g., photos/vacation">
        <div class="dialog-buttons">
          <button class="cancel-btn" id="dir-edit-cancel">Cancel</button>
          <button class="save-btn" id="dir-edit-save">Save</button>
        </div>
      </div>
    </div>

    <!-- External Drop Overlay -->
    <div class="external-drop-overlay" id="external-drop-overlay">
      <span class="drop-icon">ðŸ“¥</span>
      <span class="drop-text" id="drop-text">Drop image here to add</span>
    </div>

    <!-- Drop Feedback Toast -->
    <div class="drop-feedback" id="drop-feedback"></div>

    <!-- Floating UI for smart tooltip positioning -->
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.7.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.7.4"></script>

    <!-- Modular JS - order matters: dependencies first -->
    <script src="src/shared/constants.js"></script>
    <script src="src/shared/url-utils.js"></script>
    <script src="src/shared/storage-utils.js"></script>
    <script src="src/downloads/filename-utils.js"></script>
    <script src="src/downloads/tree-builder.js"></script>
    <script src="src/downloads/download-manager.js"></script>
    <script src="src/groups/group-manager.js"></script>
    <script src="src/ui/selection.js"></script>
    <script src="src/ui/modals.js"></script>
    <script src="src/settings/theme-manager.js"></script>

    <!-- Icon system -->
    <script src="icons.js"></script>
    <!-- Main popup logic -->
    <script src="popup.js"></script>
  </body>
</html>
